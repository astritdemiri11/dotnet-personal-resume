function enableMouseInteraction(c,b){var d=!1,a=document.getElementById(b);a.addEventListener("mousedown",function(b){d=!0;var e=b.clientX-a.offsetLeft+document.body.scrollLeft+document.documentElement.scrollLeft,f=b.clientY-a.offsetTop+document.body.scrollTop+document.documentElement.scrollTop;c.touchWater(e,f,1.5,d?finger:pixel)},!1),a.addEventListener("mouseup",function(a){d=!1},!1),a.addEventListener("mousemove",function(b){var e=b.clientX-a.offsetLeft+document.body.scrollLeft+document.documentElement.scrollLeft,f=b.clientY-a.offsetTop+document.body.scrollTop+document.documentElement.scrollTop;c.touchWater(e,f,1.5,d?finger:pixel)},!1)}function createRadialCanvas(b,a){var c=document.createElement("canvas");c.setAttribute("width",b),c.setAttribute("height",a);var d=(pointerCtx=c.getContext("2d")).createRadialGradient(b/2,a/2,0,b/2,a/2,a/2);return d.addColorStop(0,"#fff"),d.addColorStop(1,"#000"),pointerCtx.fillStyle=d,pointerCtx.fillRect(0,0,b,a),c}function create2DArray(f){for(var b=f.width,g=f.height,d=new Array(b),a=0;a<b;a++){d[a]=new Array(g);for(var c=0;c<g;c++)d[a][c]=0}for(var h=f.getContext("2d").getImageData(0,0,b,g).data,e=0;e<(n=h.length);e+=4){var j=h[e]/255,i=e/4,a=i%b,c=(i-a)/b;d[a][c]=j}return d}(WaterCanvas=function(b,c,d,e,a){if(a=a||{},this.backgroundImageUrl=a.backgroundImageUrl||null,this.lightRefraction=a.lightRefraction||9,this.lightReflection=a.lightReflection||.1,this.showStats=a.showStats||!1,this.width=b,this.height=c,this.documentElement=document.getElementById(d),this.waterModel=e,this.canvas=document.createElement("canvas"),this.canvasHelp=document.createElement("canvas"),!this.canvas.getContext||!this.canvasHelp.getContext){alert("You need a browser that supports the HTML5 canvas tag.");return}if(this.ctx=this.canvas.getContext("2d"),this.ctxHelp=this.canvasHelp.getContext("2d"),this.setSize(b,c),this.documentElement.appendChild(this.canvas),this.fps=-1,this.showStats){this.fpsCounter=0,this.prevMs=0;var f=this;setInterval(function(){f.findFps()},1e3)}this.drawNextFrame()}).prototype.setSize=function(a,b){this.width=a,this.height=b,this.canvas.setAttribute("width",this.width),this.canvas.setAttribute("height",this.height),this.canvasHelp.setAttribute("width",this.width),this.canvasHelp.setAttribute("height",this.height),this.setBackground(this.backgroundImageUrl)},WaterCanvas.prototype.setBackground=function(b){if(this.backgroundImageUrl=""==b?null:b,this.pixelsIn=null,null!=this.backgroundImageUrl){this.backgroundImg=new Image;var d=this;this.backgroundImg.onload=function(){d.ctxHelp.drawImage(d.backgroundImg,0,0,d.width,d.height);var a=d.ctxHelp.getImageData(0,0,d.width,d.height);d.pixelsIn=a.data,d.ctx.putImageData(a,0,0)},this.backgroundImg.src=this.backgroundImageUrl}else{var a=pointerCtx.createRadialGradient(this.width/2,this.height/2,0,this.width/2,this.height/2,this.height/2);a.addColorStop(0,"#4af"),a.addColorStop(1,"#000"),this.ctxHelp.fillStyle=a,this.ctxHelp.fillRect(0,0,this.width,this.height),this.ctxHelp.shadowColor="white",this.ctxHelp.shadowOffsetX=0,this.ctxHelp.shadowOffsetY=0,this.ctxHelp.shadowBlur=10,this.ctxHelp.textBaseline="top",this.ctxHelp.font="normal 200 45px verdana",this.ctxHelp.fillStyle="white",this.ctxHelp.fillText("Water Canvas",10,this.height/2-40),this.ctxHelp.font="normal 200 12px verdana",this.ctxHelp.fillText("Move your mouse over this canvas to move the water.",10,this.height/2+10),this.ctxHelp.fillText("By Almeros 2010, See http://code.almeros.com",10,this.height/2+30);var c=this.ctxHelp.getImageData(0,0,this.width,this.height);this.pixelsIn=c.data,this.ctx.putImageData(c,0,0)}},WaterCanvas.prototype.drawNextFrame=function(){if(null==this.pixelsIn||!this.waterModel.isEvolving()){var l=this;setTimeout(function(){l.drawNextFrame()},50);return}for(var h=this.ctx.getImageData(0,0,this.width,this.height),c=h.data,a=0;a<(n=c.length);a+=4){var i=a/4,f=i%this.width,j=(i-f)/this.width,b=this.waterModel.getWater(f,j),k=Math.round(b*this.lightRefraction),d=f+k,e=j+k;d<0&&(d=0),e<0&&(e=0),d>this.width-1&&(d=this.width-1),e>this.height-1&&(e=this.height-1);var g=(e*this.width+d)*4,m=this.pixelsIn[g],n=this.pixelsIn[g+1],o=this.pixelsIn[g+2];b*=this.lightReflection,b+=1,c[a]=m*=b,c[a+1]=n*=b,c[a+2]=o*=b,c[a+3]=255}this.ctx.putImageData(h,0,0),this.showStats&&(this.fpsCounter++,this.ctx.textBaseline="top",this.ctx.font="normal 200 10px arial",this.ctx.fillStyle="white",this.ctx.fillText("FPS Canvas: "+this.getFps(),10,10),this.ctx.fillText("FPS Water: "+this.waterModel.getFps(),10,20),this.ctx.shadowColor="black",this.ctx.shadowOffsetX=0,this.ctx.shadowOffsetY=0,this.ctx.shadowBlur=2);var l=this;requestAnimFrame(function(){l.drawNextFrame()},this.canvas)},WaterCanvas.prototype.findFps=function(){if(this.showStats){var a=new Date().getTime(),b=a-this.prevMs;this.fps=Math.round(1e3*this.fpsCounter/b*10)/10,this.prevMs=a,this.fpsCounter=0}},WaterCanvas.prototype.getFps=function(){return this.fps},WaterCanvas.prototype.setLightRefraction=function(a){this.lightRefraction=a},WaterCanvas.prototype.setLightReflection=function(a){this.lightReflection=a},(WaterModel=function(b,c,a){if(a=a||{},this.resolution=a.resolution||2,this.interpolate=a.interpolate||!1,this.damping=a.damping||.985,this.clipping=a.clipping||5,this.maxFps=a.maxFps||30,this.showStats=a.showStats||!1,this.evolveThreshold=a.evolveThreshold||.05,this.width=Math.ceil(b/this.resolution),this.height=Math.ceil(c/this.resolution),this.resetSizeAndResolution(b,c,this.resolution),this.swapMap,this.setMaxFps(this.maxFps),this.evolving=!1,this.fps=-1,this.showStats){this.fpsCounter=0,this.prevMs=0;var d=this;setInterval(function(){d.findFps()},1e3)}}).prototype.getWater=function(c,d){if(xTrans=c/this.resolution,yTrans=d/this.resolution,!this.interpolate||1==this.resolution)return(xF=Math.floor(xTrans),yF=Math.floor(yTrans),xF>this.width-1||yF>this.height-1)?0:this.depthMap1[xF][yF];if(xF=Math.floor(xTrans),yF=Math.floor(yTrans),xC=Math.ceil(xTrans),yC=Math.ceil(yTrans),xC>this.width-1||yC>this.height-1)return 0;var e=this.depthMap1[xF][yF],f=this.depthMap1[xC][yF],g=this.depthMap1[xF][yC],h=this.depthMap1[xC][yC],a=xC-xTrans,b=yC-yTrans,i=h*(1-a)*(1-b)+g*a*(1-b)+f*b*(1-a)+e*a*b;return i},WaterModel.prototype.setInterpolation=function(a){this.interpolate=a},WaterModel.prototype.touchWater=function(a,b,f,c){this.evolving=!0,a=Math.floor(a/this.resolution),b=Math.floor(b/this.resolution),(c.length>4||c[0].length>4)&&(a-=c.length/2,b-=c[0].length/2),a<0&&(a=0),b<0&&(b=0),a>this.width&&(a=this.width),b>this.height&&(b=this.height);for(var d=0;d<c.length;d++)for(var e=0;e<c[0].length;e++)a+d>=0&&b+e>=0&&a+d<=this.width-1&&b+e<=this.height-1&&(this.depthMap1[a+d][b+e]-=c[d][e]*f)},WaterModel.prototype.renderNextFrame=function(){if(this.evolving){this.evolving=!1;for(var a=0;a<this.width;a++)for(var b=0;b<this.height;b++){var c=(0==a?0:this.depthMap1[a-1][b])+(a==this.width-1?0:this.depthMap1[a+1][b])+(0==b?0:this.depthMap1[a][b-1])+(b==this.height-1?0:this.depthMap1[a][b+1]);(c=(c/2-this.depthMap2[a][b])*this.damping)>this.clipping&&(c=this.clipping),c< -this.clipping&&(c=-this.clipping),Math.abs(c)>this.evolveThreshold&&(this.evolving=!0),this.depthMap2[a][b]=c}this.swapMap=this.depthMap1,this.depthMap1=this.depthMap2,this.depthMap2=this.swapMap,this.fpsCounter++}},WaterModel.prototype.isEvolving=function(){return this.evolving},WaterModel.prototype.findFps=function(){if(this.showStats){var a=new Date().getTime(),b=a-this.prevMs;this.fps=Math.round(1e3*this.fpsCounter/b*10)/10,this.prevMs=a,this.fpsCounter=0}},WaterModel.prototype.getFps=function(){return this.fps},WaterModel.prototype.setMaxFps=function(a){this.maxFps=a,clearInterval(this.maxFpsInterval);var b=this;this.maxFps>0&&(this.maxFpsInterval=setInterval(function(){b.renderNextFrame()},1e3/this.maxFps))},WaterModel.prototype.setDamping=function(a){this.damping=a},WaterModel.prototype.resetSizeAndResolution=function(d,e,c){this.width=Math.ceil(d/c),this.height=Math.ceil(e/c),this.resolution=c,this.depthMap1=new Array(this.width),this.depthMap2=new Array(this.width);for(var a=0;a<this.width;a++){this.depthMap1[a]=new Array(this.height),this.depthMap2[a]=new Array(this.height);for(var b=0;b<this.height;b++)this.depthMap1[a][b]=0,this.depthMap2[a][b]=0}},(RainMaker=function(a,b,c,d){this.width=a,this.height=b,this.waterModel=c,this.raindrop2dArray=d,this.rainMinPressure=1,this.rainMaxPressure=3}).prototype.raindrop=function(){var a=Math.floor(Math.random()*this.width),b=Math.floor(Math.random()*this.height);this.waterModel.touchWater(a,b,this.rainMinPressure+Math.random()*this.rainMaxPressure,this.raindrop2dArray)},RainMaker.prototype.setRaindropsPerSecond=function(a){if(this.rps=a,clearInterval(this.rainInterval),this.rps>0){var b=this;this.rainInterval=setInterval(function(){b.raindrop()},1e3/this.rps)}},RainMaker.prototype.setRainMinPressure=function(a){this.rainMinPressure=a},RainMaker.prototype.setRainMaxPressure=function(a){this.rainMaxPressure=a},window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a,b){window.setTimeout(a,1e3/60)}
